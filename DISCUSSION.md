# DISCUSSION.md

本ファイルは、設計・実装の過程で発生した**確認事項・議論したい事項**を記録する。
Biz側やメンバーへの相談・確認が必要な項目を集約し、設計ドキュメントとは分離して管理する。

---

## 📋 確認事項一覧

### 1. valid_until の時刻単位対応の必要性

**分類**: 業務要件確認
**対象ドキュメント**: [03_database.md](./docs/03_database.md)
**優先度**: 中

#### 現状

* `valid_until` カラムは **date 型**（日付のみ）で設計
* 「2025-08-31 まで有効」といった日単位の有効期限を想定

#### 確認したいこと

営業時間が「翌1時まで」など、**時刻単位で有効性が変わる運用**が存在するか？

* **存在する場合**: `valid_until_at: datetime` 型への移行を検討
* **存在しない場合**: 現行の date 型で問題なし

#### 影響範囲

* DB スキーマ（カラム型変更）
* API 仕様（入出力フォーマット）
* バリデーションロジック
* タイムゾーン処理

#### 対応方針（暫定）

現時点では date 型を採用し、将来の拡張に備えて以下の配慮を実施：

* 日付比較ロジックをモデル層メソッド（`Coupon#active?`）に集約を予定する。
* Serializer・Schema定義に「日付単位」と明記

---

### 2. 管理者の越境参照権限の有無

**分類**: セキュリティ要件確認
**対象ドキュメント**: [05_security.md](./docs/05_security.md)
**優先度**: 高

#### 現状

* すべてのアクセスは `current_store` スコープに限定
* 店舗オーナーは自店舗のデータのみ参照・操作可能

#### 確認したいこと

管理者（運営側）が**複数店舗のデータを越境して参照**する運用を想定するか？

* **想定する場合**: 別の権限モデル・ドメイン分離が必要
  * 例: `admin` scope の導入、管理者専用 API エンドポイント
  * 例: `store_owner` と `admin` で認可ロジックを分離
* **想定しない場合**: 現行のテナント境界設計で問題なし

#### 影響範囲

* 認可ロジック（Pundit Policy）
* JWT scope 設計
* API エンドポイント設計
* 監査ログ設計

---


### 3. 過去日付クーポンの登録・表示仕様

**分類**: 業務要件確認
**対象ドキュメント**: [03_database.md](./docs/03_database.md), [06_testing.md](./docs/06_testing.md)
**優先度**: 低

#### 現状

* `valid_until` が過去日でも登録可能（DB・アプリ層でバリデーションなし）
* 理由: 過去のクーポンも記録として残す運用を想定

#### 確認したいこと

1. **登録時の仕様**: 過去日付のクーポンを新規作成できる仕様で問題ないか？
2. **一覧表示**: 過去のクーポンをデフォルトで表示するか、フィルタで除外するか？
   * 例: `filter[active]=true` で有効なクーポンのみ表示

#### 影響範囲

* バリデーションロジック
* API エンドポイント（フィルタ仕様）
* フロントエンド UI

---

### 4. クライアントアプリケーションのアーキテクチャとCORS設定の要否

**分類**: アーキテクチャ確認
**対象ドキュメント**: [05_security.md](./docs/05_security.md)
**優先度**: 高

#### 現状

* CORS設定は未実装（rack-cors gemはコメントアウト状態）
* 将来的に必要になった場合に備えて、実装方針を検討中

#### 確認したいこと

**外部パートナーはどのようにこのAPIを利用するのか？**

1. **パターン1: バックエンド経由（CORS不要）**
   ```
   ユーザー（ブラウザ）
     ↓ https://partner.com
   パートナーのサーバー（Node.js/PHP/Railsなど）
     ↓ サーバー間通信
   Coupon API
   ```
   * パートナーのサーバーがAPIを呼び、結果をHTMLに埋め込む
   * JWT秘密鍵はパートナーのサーバー側で管理
   * **CORS設定は不要**（サーバー間通信にはCORS制約がない）

2. **パターン2: フロントエンド直接呼び出し（CORS必要）**
   ```
   ユーザー（ブラウザ at https://partner.com）
     ↓ JavaScript fetch/axios
   Coupon API（https://api.yoursite.com）
   ```
   * ブラウザ上のJavaScriptが直接APIを呼ぶ（SPA構成）
   * ブラウザがCORSチェックを実施
   * **CORS設定が必要**

#### 影響範囲

* CORS設定の要否
* セキュリティモデル（JWT秘密鍵の配布方法）
* API設計（直接呼び出しを想定するか）

#### 対応方針（暫定）

**パターン1（バックエンド経由）を想定**し、以下の方針とする：

* CORS設定は実装するが、**デフォルトでは無効化**する想定
* 将来的にブラウザからの直接アクセスが必要になった場合に有効化

#### セキュリティ上の推奨

外部パートナーに公開するAPIの場合、**パターン1（バックエンド経由）が推奨**される理由：

* JWT秘密鍵をブラウザに露出させない
* パートナー側でキャッシュ・レート制限を管理可能

---

### 5. 認証API（/auth/login）の実装方針

**分類**: セキュリティ・認証設計
**対象ドキュメント**: [05_security.md](./docs/05_security.md), [04_api.md](./docs/04_api.md)
**優先度**: 高

#### 現状

現在の実装では、`POST /api/v1/auth/login` は　便宜上`store_id`を受け取っていますが、実際はemailとpasswordでの認証などが想定されると思います。


### 6. クーポン一覧のデフォルトソート順

**分類**: API仕様確認
**対象ドキュメント**: [03_database.md](./docs/03_database.md), [04_api.md](./docs/04_api.md)
**優先度**: 中

#### 現状

* `GET /api/v1/stores/:store_id/coupons` はソート順を指定していない
* `docs/03_database.md` には `valid_until ASC, id ASC` の記載があるが実装していない

#### 確認したいこと

1. **デフォルトソート順を固定すべきか？**
   * 固定する場合、どの順序が適切か？
     - `valid_until ASC`: 期限が近いものから（顧客向け？）
     - `valid_until DESC`: 新しいものから（管理画面向け？）
     - `id ASC`: シンプルな作成順
   * 固定しない場合、DBのデフォルト順（通常は `id ASC`）で良いか？

2. **ソートパラメータを実装すべきか？**
   * 例: `?sort=valid_until` または `?sort=-valid_until`
   * ユースケースごとに最適な順序が異なる可能性：
     - 管理画面: 新しい順（DESC）
     - 顧客向けアプリ: 期限近い順（ASC）
     - 分析用途: ID順など

#### 影響範囲

* API仕様書（デフォルト動作の明記）
* Controller実装（orderメソッド）
* インデックス設計（ソート対象カラムのインデックス）
* クライアント側の期待値

#### 対応方針（暫定）

現時点ではデフォルトソート順を**指定せず**、DB のデフォルト順（通常 `id ASC`）に従う。
将来的にソートパラメータ機能を実装する余地を残す。

## 📝 メモ

* このファイルは設計ドキュメント（`docs/`）とは分離して管理する
* 確認事項が解決した場合、決定事項セクションに移動する
* 実装に影響する決定は、該当する設計ドキュメントに反映する
