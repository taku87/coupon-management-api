# DISCUSSION.md

本ファイルは、設計・実装の過程で発生した**確認事項・議論メモ・未決定事項**を記録する。
Biz側やメンバーへの相談・確認が必要な項目を集約し、設計ドキュメントとは分離して管理する。

---

## 📋 確認事項一覧

### 1. valid_until の時刻単位対応の必要性

**分類**: 業務要件確認
**対象ドキュメント**: [03_database.md](./docs/03_database.md)
**優先度**: 中

#### 現状

* `valid_until` カラムは **date 型**（日付のみ）で設計
* 「2025-08-31 まで有効」といった日単位の有効期限を想定

#### 確認したいこと

営業時間が「翌1時まで」など、**時刻単位で有効性が変わる運用**が存在するか？

* **存在する場合**: `valid_until_at: datetime` 型への移行を検討
* **存在しない場合**: 現行の date 型で問題なし

#### 影響範囲

* DB スキーマ（カラム型変更）
* API 仕様（入出力フォーマット）
* バリデーションロジック
* タイムゾーン処理

#### 対応方針（暫定）

現時点では date 型を採用し、将来の拡張に備えて以下の配慮を実施：

* 日付比較ロジックをモデル層メソッド（`Coupon#active?`）に集約
* Serializer・Schema定義に「日付単位」と明記

---

### 2. 管理者の越境参照権限の有無

**分類**: セキュリティ要件確認
**対象ドキュメント**: [05_security.md](./docs/05_security.md)
**優先度**: 高

#### 現状

* すべてのアクセスは `current_store` スコープに限定
* 店舗オーナーは自店舗のデータのみ参照・操作可能

#### 確認したいこと

管理者（運営側）が**複数店舗のデータを越境して参照**する運用を想定するか？

* **想定する場合**: 別の権限モデル・ドメイン分離が必要
  * 例: `admin` scope の導入、管理者専用 API エンドポイント
  * 例: `store_owner` と `admin` で認可ロジックを分離
* **想定しない場合**: 現行のテナント境界設計で問題なし

#### 影響範囲

* 認可ロジック（Pundit Policy）
* JWT scope 設計
* API エンドポイント設計
* 監査ログ設計

---

### 3. 監査ログの保管期間と開示要件

**分類**: 運用・コンプライアンス確認
**対象ドキュメント**: [05_security.md](./docs/05_security.md)
**優先度**: 中

#### 現状

* 監査ログに `timestamp`, `method`, `path`, `status`, `store_uid`, `jti`, `client_ip`, `user_agent` を記録
* ボディ内容は記録しない（PII保護）

#### 確認したいこと

1. **保管期間**: ログをどの程度の期間保持するか？
   * 例: 90日、1年、3年など
2. **開示要件**: 法的開示請求や監査対応の想定はあるか？
3. **アラート設計**: 4xx/5xx 多発時のアラート閾値・通知先は？

#### 影響範囲

* ログストレージ設計（S3、CloudWatch Logs など）
* ログローテーション・削除ポリシー
* アラート設定（SNS、PagerDuty など）

---

### 4. レート制限の初期閾値と例外処理

**分類**: 運用・セキュリティ確認
**対象ドキュメント**: [05_security.md](./docs/05_security.md)
**優先度**: 中

#### 現状

以下の初期閾値を推奨値として設定：

| 区分         | 制御単位             | 推奨閾値          |
| ---------- | ---------------- | ------------- |
| 一般リクエスト    | IP               | 200 req/min   |
| 店舗単位       | `sub`（store_uid） | 600 req/10min |
| 作成系 (POST) | `sub`            | 60 req/10min  |

#### 確認したいこと

1. **初期閾値の妥当性**: 上記の値で運用開始して問題ないか？
2. **例外処理**: 特定店舗・特定IPのホワイトリスト運用は必要か？
3. **対応フロー**: レート制限発動時の連絡系統・エスカレーション手順は？

#### 影響範囲

* アプリケーション設定（環境変数）
* 監視・アラート設計
* 運用マニュアル

---

### 5. 鍵漏洩・DoS 発生時の対応体制

**分類**: インシデント対応確認
**対象ドキュメント**: [05_security.md](./docs/05_security.md)
**優先度**: 高

#### 現状

* JWT 署名鍵は `.env`（開発）、AWS Secrets Manager（本番）で管理
* 鍵ローテーション手順は文書化済み

#### 確認したいこと

1. **鍵漏洩時の対応**:
   * 誰が対応するか？（オンコール体制の有無）
   * 新鍵発行・旧鍵失効の承認フローは？
2. **DoS 攻撃時の対応**:
   * 一時的なIP遮断の判断基準・実施権限は？
   * WAF・CDN レイヤでの対策は別途実施するか？
3. **連絡系統**: インシデント発生時の連絡先・エスカレーションルートは？

#### 影響範囲

* 運用マニュアル
* インシデント対応手順書
* オンコール体制設計

---

### 6. 過去日付クーポンの登録・表示仕様

**分類**: 業務要件確認
**対象ドキュメント**: [03_database.md](./docs/03_database.md), [06_testing.md](./docs/06_testing.md)
**優先度**: 低

#### 現状

* `valid_until` が過去日でも登録可能（DB・アプリ層でバリデーションなし）
* 理由: 過去のクーポンも記録として残す運用を想定

#### 確認したいこと

1. **登録時の仕様**: 過去日付のクーポンを新規作成できる仕様で問題ないか？
2. **一覧表示**: 過去のクーポンをデフォルトで表示するか、フィルタで除外するか？
   * 例: `filter[active]=true` で有効なクーポンのみ表示
3. **UI/UX観点**: 過去クーポンの表示方法（グレーアウト、別セクションなど）

#### 影響範囲

* バリデーションロジック
* API エンドポイント（フィルタ仕様）
* フロントエンド UI

---

## 📌 決定事項（記録用）

### ✅ ridgepole 採用の合理性確認済み

* **決定日**: （未定）
* **結論**: migration 廃止のデメリットを上回る利点があり、採用を正当化
* **理由**: レビュー性・再現性・CI統合性を優先

---

## 🔄 次回確認予定

| No | 項目                  | 期日   | 担当者 | ステータス |
| -- | ------------------- | ---- | --- | ----- |
| 1  | valid_until 時刻対応の有無 | 未定   | 未定  | 未着手   |
| 2  | 管理者越境参照の有無          | 未定   | 未定  | 未着手   |
| 3  | 監査ログ保管期間            | 未定   | 未定  | 未着手   |
| 4  | レート制限閾値             | 未定   | 未定  | 未着手   |
| 5  | インシデント対応体制          | 未定   | 未定  | 未着手   |
| 6  | 過去日付クーポン仕様          | 未定   | 未定  | 未着手   |

---

## 📝 メモ

* このファイルは設計ドキュメント（`docs/`）とは分離して管理する
* 確認事項が解決した場合、決定事項セクションに移動する
* 実装に影響する決定は、該当する設計ドキュメントに反映する
